var duplicateArray=new Array(),tdColorArray=new Array(),highlightColor="#FFF3D3",bagList=jQuery("input#matchIDs").val(),identifiersInTheBag=bagList.split(" ");function initForm(buildNewBag){if(buildNewBag==null||buildNewBag!="true"){jQuery("#newBagName").attr("disabled",true);}}function updateMatchIDs(){if(bagList.length>0){jQuery("input#matchIDs").val(bagList);return true;}return false;}function checkIfAlreadyInTheBag(){jQuery("span.fakelink").each(function(index){var id=jQuery(this).attr("id");var identifier=id.substring(id.lastIndexOf("_")+1);if(isIdentifierInTheBag(identifier)){jQuery(this).click();jQuery(this).parent().html("<p>Already in your list.</p>");}});}function isIdentifierInTheBag(identifier){var array=identifiersInTheBag;for(var i=0;i<array.length;i++){if(identifier==array[i]){return true;}}return false;}function hasUnhighlightedRows(){var unhighlighted=false;jQuery("#additionalMatches table.inlineResultsTable tbody tr").each(function(index){if(jQuery(this).find("td:not(.identifier)").first().attr("style")!="background-color: rgb(255, 243, 211);"){unhighlighted=true;return false;}});return unhighlighted;}function addId2Bag(objectId,row,parentId,issueType){setLinkState("removeAllLink","active");if(jQuery("#add_"+issueType+"_"+objectId).hasClass("fakelink")){jQuery("span#add_"+issueType+"_"+objectId).removeClass("fakelink");jQuery("span#rem_"+issueType+"_"+objectId).addClass("fakelink");jQuery("span#add_"+issueType+"_"+objectId).each(function(i){var rowId=jQuery(this).parent().attr("class").split(" ")[1];colourRow(rowId,true);});if(!isIdentifierInTheBag(objectId)){identifiersInTheBag.push(objectId);updateCount("#matchCount",1);if(matchCount!=null){matchCount++;}}addIdToListOfMatches(objectId);var idArray=duplicateArray[parentId];if(idArray==null){duplicateArray[parentId]=new Array(objectId);updateCount("#"+issueType+"Count",-1);jQuery("span#add_"+issueType+"_"+objectId).each(function(i){var tdId=jQuery(this).parent().parent().attr("id").substring(3);jQuery("td#td_"+issueType+"_"+tdId).addClass("highlight");});updateCount("#initialIdCount",-1);}else{idArray[idArray.length]=objectId;duplicateArray[parentId]=idArray;}setLinkState(issueType+"removeAllLink","active");updateFurtherMatchesDisplay();}else{}}function removeIdFromBag(objectId,row,parentId,issueType){setLinkState("addAllLink","active");if(jQuery("#rem_"+issueType+"_"+objectId).hasClass("fakelink")){jQuery("span#rem_"+issueType+"_"+objectId).removeClass("fakelink");jQuery("span#add_"+issueType+"_"+objectId).addClass("fakelink");jQuery("span#add_"+issueType+"_"+objectId).each(function(i){var rowId=jQuery(this).parent().attr("class").split(" ")[1];colourRow(rowId,false);});if(isIdentifierInTheBag(objectId)){identifiersInTheBag.splice(identifiersInTheBag.indexOf(objectId),1);updateCount("#matchCount",-1);if(matchCount!=null){matchCount--;}}removeIdFromListOfMatches(objectId);var idArray=duplicateArray[parentId];if(idArray!=null){if(idArray.length==1){updateCount("#"+issueType+"Count",1);jQuery("span#add_"+issueType+"_"+objectId).each(function(i){var tdId=jQuery(this).parent().parent().attr("id").substring(3);jQuery("td#td_"+issueType+"_"+tdId).removeClass("highlight");});updateCount("#initialCount",-1);duplicateArray[parentId]=null;}else{var idArrayCopy=new Array();jQuery.each(idArray,function(i,value){if(objectId!=value){idArrayCopy[idArrayCopy.length]=idArray[i];}});duplicateArray[parentId]=idArrayCopy;}}setLinkState(issueType+"addAllLink","active");updateFurtherMatchesDisplay();}}function colourRow(rowClass,highlighted){jQuery("td."+rowClass).each(function(index){if(highlighted){tdColorArray[rowClass]=jQuery(this).css("background-color");jQuery(this).css("background-color",highlightColor);}else{jQuery(this).css("background-color",tdColorArray[rowClass]);}});}function updateCount(element,amount){if(jQuery(element).length>0){var count=parseInt(jQuery(element).text())+amount;jQuery(element).text(count);}}function updateFurtherMatchesDisplay(){if(jQuery("input#saveList").length>0){if(matchCount>0){jQuery("input#saveList").parent().removeClass("inactive");if(matchCount>1){jQuery("input#saveList").val("Save a list of "+matchCount+" "+listType+"s");}else{jQuery("input#saveList").val("Save a list of "+matchCount+" "+listType);}}else{jQuery("input#saveList").parent().addClass("inactive");jQuery("input#saveList").val("0 "+listType);}if(jQuery("p#furtherMatches").length>0){if(hasUnhighlightedRows()){jQuery("p#furtherMatches").html(furtherMatchesText);}else{jQuery("p#furtherMatches").html(null);}}}}function unHighlightRow(rowId){colourRow(rowId,false);}function addIdToListOfMatches(identifier){if(bagList.indexOf(identifier)==-1){if(bagList.length>0){bagList+=" ";}bagList+=identifier;}}function removeIdFromListOfMatches(identifier){if(bagList.indexOf(identifier)>-1){bagList=jQuery.grep(bagList.split(" "),function(value){return value!=identifier;});bagList=bagList.toString().replace(new RegExp(",","g")," ");}else{}}function addAll(issue,flatArray){var a=flatArray.split("|");if(a.length>100){var r=window.confirm("There are many items in the table. This operation can take a while. Please be patient and do not stop script or cancel it now.");if(!(r==true)){return;}jQuery("#error_msg.topBar.errors").clone().addClass("loading").attr("id","addingIdentifiers").html("<p>Additional matches are being resolved, please wait.</p>").appendTo(jQuery("#error_msg.topBar.errors").parent()).show();}jQuery("<div/>",{"class":"loading"}).appendTo(jQuery("#sidebar ul li."+issue));jQuery.each(a,function(i,v){im.queue.put(function(){var b=v.split(",");addId2Bag(b[0],b[1],b[2],b[3]);},this);});im.queue.put(function(){jQuery("#sidebar ul li."+issue+" div.loading").remove();toggleBagLinks(issue,"add");jQuery("#addingIdentifiers").remove();},this);}function removeAll(issue,flatArray){var a=flatArray.split("|");if(a.length>100){var r=window.confirm("There are many items in the table. This operation can take a while. Please be patient and do not stop script or cancel it now.");if(!(r==true)){return;}jQuery("#error_msg.topBar.errors").clone().addClass("loading").attr("id","removingIdentifiers").html("<p>Removing identifiers from a bag, please wait.</p>").appendTo(jQuery("#error_msg.topBar.errors").parent()).show();}jQuery("<div/>",{"class":"loading"}).appendTo(jQuery("#sidebar ul li."+issue));jQuery.each(a,function(i,v){im.queue.put(function(){var b=v.split(",");removeIdFromBag(b[0],b[1],b[2],b[3]);},this);});im.queue.put(function(){jQuery("#sidebar ul li."+issue+" div.loading").remove();toggleBagLinks(issue,"remove");jQuery("#removingIdentifiers").remove();},this);}function toggleBagLinks(issue,action){toggleBagLink(issue,action);if(issue=="all"){toggleBagLink("lowQ",action);toggleBagLink("duplicate",action);toggleBagLink("converted",action);}}function toggleBagLink(issue,action){var addAllLink="addAllLink";var removeAllLink="removeAllLink";if(issue!="all"){addAllLink=issue+addAllLink;removeAllLink=issue+removeAllLink;if(jQuery("#sidebar").length>0){jQuery("#sidebar ul li."+issue).toggleClass("added");}}if(action=="remove"){setLinkState(addAllLink,"active");setLinkState(removeAllLink,"passive");}else{setLinkState(addAllLink,"passive");setLinkState(removeAllLink,"active");}}function setLinkState(link,state){if(jQuery("#"+link).length>0){if(state=="active"){jQuery("#"+link).addClass("fakelink");}else{jQuery("#"+link).removeClass("fakelink");}}}