<!--
  Tasks and target for building a complete web application which includes a
  model, and is deployable

  properties:
    base.webapp.project - the project the contains the base webapp that we
                          will add to - must be in the project.dependencies too

-->

<project name="application" default="default" basedir="."
         xmlns:appl="http://www.intermine.org/ns/im-appl-proj/1"
         xmlns:task="http://www.intermine.org/ns/im-task-proj/1">

  <dirname property="application.xml.basedir" file="${ant.file.application}"/>
  <import file="${application.xml.basedir}/webapp.xml"/>
  <import file="${application.xml.basedir}/task.xml"/>

  <!-- Local webapp build/deploy properties -->
  <property name="build.properties.local" value="${user.home}/build.properties.${ant.project.name}" />
  <property file="${build.properties.local}"/>

  <!-- INIT -->

  <target name="-pre-init" depends="webapp.-pre-init">
    <!-- Files -->
    <property name="default.template.queries" location="${src.dir}/default-template-queries.xml"/>
    <!-- Location of model-less intermine-webapp.war -->
    <property name="source.intermine.webapp.war" location="${application.xml.basedir}/../${base.webapp.path}"/>
  </target>

  <!-- this may not be the most appropriate place for these two targets, but
       most targets defined by this file need the intermine.properties file -->
  <target name="-init-check-for-intermine-properties" depends="-init-deps">
    <available file="${user.home}/${intermine.properties.file}"
               property="have.intermine.properties.file"/>
  </target>

  <target name="-check-for-intermine-properties" depends="-init-check-for-intermine-properties"
          unless="have.intermine.properties.file">
    <fail message="you need to set the intermine.properties.file property in your project"
          unless="temporary.webapp.project"/>
  </target>


  <!-- WAR INSTEAD OF JAR -->

  <target name="-final-app-pre-jar" unless="temporary.webapp.project">
    <!-- Concatenate local build.properties with web.properties -->
    <concat destfile="${build.dir}/webapp/WEB-INF/web.properties" force="false">
      <fileset file="resources/web.properties"/>
      <fileset file="${build.properties.local}"/>
    </concat>
    <copy file="${user.home}/${intermine.properties.file}"
          tofile="${build.dir}/webapp/WEB-INF/classes/intermine.properties"/>
    <copy file="${default.intermine.properties.file}"
          tofile="${build.dir}/webapp/WEB-INF/classes/default.intermine.properties"/>
  </target>

  <target name="-pre-jar" 
          depends="-check-for-intermine-properties, -final-app-pre-jar, webapp.-pre-jar">
    <!-- Start with base intermine webapp war -->
    <copy file="${source.intermine.webapp.war}" tofile="${dist.war}"/>
  </target>

  <target name="do-jar" depends="-init-presetdef-war">
    <appl:war/>
  </target>

  <!-- USER PROFILE -->

  <target name="-init-build-db" depends="init, -init-deps, -init-task-xml">
    <!-- Copy intermine.properties onto the task classpath -->
    <copy file="${user.home}/${intermine.properties.file}"
          tofile="${build.task.dir}/intermine.properties"/>
    <!-- Copy default.intermine.properties into build/classes -->
    <copy file="${default.intermine.properties.file}"
          tofile="${build.task.dir}/default.intermine.properties"/>
  </target>
  
  <target name="build-db-userprofile" depends="-do-build-db-userprofile, load-default-templates"/>
  
  <target name="-do-build-db-userprofile" depends="-init-build-db">
    <task:build-db osname="${userprofile.objectstore.name}"
                       dbname="${userprofile.db.name}"
                       model="${userprofile.model.name}"/>
  </target>
  
  <target name="load-default-templates" depends="-init-build-db">
    <load-default-templates templatesXml="${default.template.queries}"
                            username="${superuser.account}" osAlias="${objectstore.name}"
                            userProfileAlias="${userprofile.objectstorewriter.name}"/>
  </target>

  <target name="dump-default-templates" depends="-init-build-db">
    <dump-default-templates fileName="${default.template.queries}"
                            username="${superuser.account}" osAlias="${objectstore.name}"
                            userProfileAlias="${userprofile.objectstorewriter.name}"/>
  </target>

  <target name="write-userprofile-xml" depends="-init-build-db">
    <write-userprofile-xml fileName="${build.dir}/userprofile.xml" osAlias="${objectstore.name}"
                           userProfileAlias="${userprofile.objectstorewriter.name}"/>
  </target>

  <target name="read-userprofile-xml" depends="-init-build-db">
    <read-userprofile-xml fileName="${build.dir}/userprofile.xml" osAlias="${objectstore.name}"
                          userProfileAlias="${userprofile.objectstorewriter.name}"/>
  </target>

  <!-- PRECOMPUTING -->

  <target name="drop-precomputed-tables" depends="-init-build-db">
    <drop-precomputed-tables alias="${objectstore.name}"/>
  </target>

  <target name="precompute-queries" depends="-init-build-db">
    <precompute-queries alias="${objectstore.name}"
                        summaryPropertiesFile="objectstoresummary.properties"
                        minRows="0"/>
  </target>

  <target name="precompute-queries-test" depends="-init-build-db">
    <precompute-queries alias="${objectstore.name}" testMode="true"
                        summaryPropertiesFile="objectstoresummary.properties"
                        minRows="0"/>
  </target>

  <target name="precompute-templates" depends="-init-build-db">
    <precompute-templates alias="${objectstore.name}" userProfileAlias="${userprofile.objectstorewriter.name}"
                          minRows="0" username="${superuser.account}"/>
  </target>

  <!-- CONSOLE -->
  
  <target name="console" depends="skip-deps, -init-build-db">
    <copy file="${application.xml.basedir}/console.bshrc" tofile="${user.home}/.bshrc"/>
    <java classname="bsh.Console" fork="true" spawn="true">
      <classpath>
        <pathelement location="${application.xml.basedir}/lib/bsh-2.0b4.jar"/>
        <path refid="task.class.path"/>
      </classpath>
    </java>
  </target>
  
  <!-- MACRO DEFINITIONS -->

  <target name="-init-presetdef-war">
    <macrodef name="war" uri="http://www.intermine.org/ns/im-appl-proj/1">
      <sequential>
        <war compress="${jar.compress}" destfile="${dist.war}" update="true">
          <fileset dir="${build.dir}/webapp"/>
        </war>
      </sequential>
    </macrodef>
  </target>

</project>
