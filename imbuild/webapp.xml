
<project name="webapp" default="default" basedir="." xmlns:webapp="http://www.intermine.org/ns/im-webapp-proj/1">

  <dirname property="webapp.xml.basedir" file="${ant.file.webapp}"/>
  
  <import file="${webapp.xml.basedir}/library.xml"/>
  
  <target name="-pre-pre-init" depends="library.-pre-pre-init">
    <property name="resources.dir" location="resources/main"/>
  </target>
  
  <available file="${model.name}.zargo" property="have.zargo"/>

  <target name="-pre-init" depends="library.-pre-init">
    <property name="dist.war" location="${dist.dir}/${ant.project.name}.war"/>
    <!-- War settings -->
    <property name="war.update" value="false"/>
    <property name="deploy.excludes" value=""/>
  </target>
  
  <!-- WAR INSTEAD OF JAR -->
  
  <target name="-pre-jar">
    <dependencies basedir="${library.xml.basedir}/.." buildDependencies="false"
                  type="deploy" noFollow="true"/>
    <!-- copy all dependencies into build/lib -->
    <mkdir dir="${build.dir}/webapp/WEB-INF"/>
    <mkdir dir="${build.dir}/webapp/WEB-INF/lib"/>
    <mkdir dir="${build.dir}/webapp/WEB-INF/classes"/>
    <copy todir="${build.dir}/webapp/WEB-INF/classes">
      <fileset dir="${build.classes.dir}"/>
    </copy>
    <copy todir="${build.dir}/webapp">
      <fileset dir="resources/webapp"/>
    </copy>
  	<property name="jarFiles" refid="deploy.execute.path.fileset.text"/>
    <copy todir="${build.dir}/webapp/WEB-INF/lib" flatten="true" >
      <fileset dir="${webapp.xml.basedir}/.." includes="${jarFiles}" excludes="${deploy.excludes}" />
    </copy>
  </target>
  
  <target name="do-jar" depends="-init-presetdef-war">
    <webapp:war/>
  </target>
  
  <!-- RELEASE / REMOVE FROM TOMCAT -->
  
  <target name="release-webapp" depends="init">
    <taskdef name="tomcat-deploy" classname="org.apache.catalina.ant.DeployTask"
             classpath="${webapp.xml.basedir}/lib/catalina-ant.jar"/>
    <tomcat-deploy url="${webapp.deploy.url}/manager"
                   username="${webapp.manager}" 
                   password="${webapp.password}"
                   path="/${webapp.path}" 
                   war="file://${dist.war}"/>
  </target>

  <target name="remove-webapp" depends="init">
    <taskdef name="tomcat-undeploy" classname="org.apache.catalina.ant.UndeployTask"
             classpath="${webapp.xml.basedir}/lib/catalina-ant.jar"/>
    <tomcat-undeploy url="${webapp.deploy.url}/manager"
                     username="${webapp.manager}" 
                     password="${webapp.password}"
                     path="/${webapp.path}"/>
  </target>
  
  <!-- MACRO DEFINITIONS -->
  
  <target name="-init-presetdef-war">
    <macrodef name="war" uri="http://www.intermine.org/ns/im-webapp-proj/1">
      <sequential>
        <war compress="${jar.compress}" warfile="${dist.war}" 
             webxml="${build.dir}/webapp/WEB-INF/web.xml">
          <fileset dir="${build.dir}/webapp" />
        </war>
      </sequential>
    </macrodef>
  </target>
  
</project>
